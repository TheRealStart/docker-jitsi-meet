#!/usr/bin/with-contenv bash

MISSED_APP_NAME="${CUSTOM_APP_NAME:=Missed.com}"
MISSED_APP_BG="${CUSTOM_APP_BACKGROUND:=474747}"
MISSED_WATERMARK_URL="${CUSTOM_WATERMARK_URL:=https://missed.com}"
MISSED_ENABLE_WELCOME_PAGE="${CUSTOM_ENABLE_WELCOME_PAGE:=true}"
MISSED_DISABLE_SCREEN_SHARING="${CUSTOM_DISABLE_SCREEN_SHARING:=false}"
MISSED_ENABLE_TRANSLATION="${CUSTOM_ENABLE_TRANSLATION:=true}"

# make our folders
mkdir -p \
    /config/{nginx/site-confs,keys} \
    /run \
    /var/lib/nginx/tmp/client_body \
    /var/tmp/nginx

# generate keys (maybe)
if [[ $DISABLE_HTTPS -ne 1 ]]; then
    if [[ $ENABLE_LETSENCRYPT -eq 1 ]]; then
        if [[ ! -f /etc/letsencrypt/live/$LETSENCRYPT_DOMAIN/fullchain.pem ]]; then
            if ! certbot-auto \
                  certonly \
                  --no-self-upgrade \
                  --noninteractive \
                  --standalone \
                  --preferred-challenges http \
                  -d $LETSENCRYPT_DOMAIN \
                  --agree-tos \
                  --email $LETSENCRYPT_EMAIL ; then

                echo "Failed to obtain a certificate from the Let's Encrypt CA."
                # this tries to get the user's attention and to spare the
                # authority's rate limit:
                sleep 15
                echo "Exiting."
                exit 1
            fi
        fi

        # remove default certbot renewal
        if [[ -f /etc/cron.d/certbot ]]; then
            rm /etc/cron.d/certbot
        fi

        # setup certbot renewal script
        if [[ ! -f /etc/cron.daily/letencrypt-renew ]]; then
            cp /defaults/letsencrypt-renew /etc/cron.daily/
        fi
    else
        # use self-signed certs
        if [[ -f /config/keys/cert.key && -f /config/keys/cert.crt ]]; then
            echo "using keys found in /config/keys"
        else
            echo "generating self-signed keys in /config/keys, you can replace these with your own keys if required"
            SUBJECT="/C=US/ST=TX/L=Austin/O=jitsi.org/OU=Jitsi Server/CN=*"
            openssl req -new -x509 -days 3650 -nodes -out /config/keys/cert.crt -keyout /config/keys/cert.key -subj "$SUBJECT"
        fi
    fi
fi

# copy config files
if [[ ! -f /config/nginx/nginx.conf ]]; then
    cp /defaults/nginx.conf /config/nginx/nginx.conf
fi

if [[ ! -f /config/nginx/meet.conf ]]; then
    tpl /defaults/meet.conf > /config/nginx/meet.conf
fi

if [[ ! -f /config/nginx/ssl.conf ]]; then
    tpl /defaults/ssl.conf > /config/nginx/ssl.conf
fi

if [[ ! -f /config/nginx/site-confs/default ]]; then
    tpl /defaults/default > /config/nginx/site-confs/default
fi

if [[ ! -f /config/config.js ]]; then
    cp /defaults/config.js /config/config.js
    sed -i \
        -e "s#jitsi-meet.example.com#$XMPP_DOMAIN#g" \
        -e "s#bosh:.*#bosh: '/http-bind',#" \
        -e "s#muc:.*#muc: '${XMPP_MUC_DOMAIN}',#" \
        -e "s#// focusUserJid:.*#focusUserJid: '${JICOFO_AUTH_USER}@${XMPP_AUTH_DOMAIN}',#" \
        /config/config.js

    if [[ $ENABLE_RECORDING -eq 1 || x$ENABLE_RECORDING == xtrue ]]; then
        sed -i \
            -e "/\/\/ Recording.*/a hiddenDomain: '$XMPP_RECORDER_DOMAIN'," \
            -e "s#// fileRecordingsEnabled:.*#fileRecordingsEnabled: true,#" \
            -e "s#// liveStreamingEnabled:.*#liveStreamingEnabled: true,#" \
        /config/config.js
    fi

    if [[ $ENABLE_AUTH -eq 1 ]]; then
        if [[ $ENABLE_GUESTS -eq 1 ]]; then
            sed -i \
                -e "s#// anonymousdomain:.*#anonymousdomain: '${XMPP_GUEST_DOMAIN}',#" \
                /config/config.js
        fi

        sed -i \
            -e "s#// authdomain:.*#authdomain: '${XMPP_DOMAIN}',#" \
            /config/config.js
    fi

    if [[ -z "$(grep -om1 'etherpad_base:' /config/config.js)" ]]; then
        if [[ ! -z "${ETHERPAD_PUBLIC_URL}" ]]; then
            sed -i \
                -e "/enableWelcomePage/a\    etherpad_base: '${ETHERPAD_PUBLIC_URL}/p/'," \
                /config/config.js
        elif [[ ! -z "${ETHERPAD_URL_BASE}" ]]; then
            sed -i \
                -e "/enableWelcomePage/a\    etherpad_base: '${PUBLIC_URL}/etherpad/p/'," \
                /config/config.js
        fi
    fi

    if [[ $ENABLE_TRANSCRIPTIONS -eq 1 || "$ENABLE_TRANSCRIPTIONS" == "true" ]]; then
        sed -i \
             -e "s#// transcribingEnabled:.*#transcribingEnabled: true,#" \
             /config/config.js
    fi

    if [[ $MISSED_ENABLE_WELCOME_PAGE -ne 1 || "$MISSED_ENABLE_WELCOME_PAGE" != "true" ]]; then
        sed -i \
            -e "s#enableWelcomePage:.*#enableWelcomePage: $MISSED_ENABLE_WELCOME_PAGE,#" \
            /config/config.js
    fi

    if [[ $MISSED_ENABLE_TRANSLATION -ne 1 || "$MISSED_ENABLE_TRANSLATION" != "true" ]]; then
        sed -i \
            -e "s#enableTranslation:.*#enableTranslation: $MISSED_ENABLE_TRANSLATION,#" \
            /config/config.js
    fi

    if [[ $MISSED_DISABLE_SCREEN_SHARING -eq 1 || "$MISSED_DISABLE_SCREEN_SHARING" == "true" ]]; then
        sed -i \
            -e "s#// desktopSharingChromeDisabled:.*#desktopSharingChromeDisabled: true,#" \
            -e "s#// desktopSharingFirefoxDisabled:.*#desktopSharingFirefoxDisabled: true,#" \
            /config/config.js
    fi

    sed -i \
        -e "s#// resolution:.*#resolution: 480,#" \
        /config/config.js

    sed -i \
        "s/stun:meet-jit-si-turnrelay.jitsi.net:443/${JVB_STUN_SERVERS}/1" \
        /config/config.js

    sed -i \
        "/s/enabled: true/enabled: false/1" \
        /config/config.js

fi

if [[ ! -f /config/interface_config.js ]]; then
    cp /defaults/interface_config.js /config/interface_config.js

    # Custom modifications
    sed -i \
        -e "s#DEFAULT_REMOTE_DISPLAY_NAME:.*#DEFAULT_REMOTE_DISPLAY_NAME: 'Participant',#" \
        -e "s#APP_NAME:.*#APP_NAME: '$MISSED_APP_NAME',#" \
        -e "s#NATIVE_APP_NAME:.*#NATIVE_APP_NAME: '$MISSED_APP_NAME',#" \
        -e "s#PROVIDER_NAME:.*#PROVIDER_NAME: '$MISSED_APP_NAME',#" \
        -e "s#DEFAULT_BACKGROUND:.*#DEFAULT_BACKGROUND: '\#$MISSED_APP_BG',#" \
        -e "s#JITSI_WATERMARK_LINK:.*#JITSI_WATERMARK_LINK: '$MISSED_WATERMARK_URL',#" \
        /config/interface_config.js

    # Performance gain
    sed -i \
        -e "s#DISABLE_VIDEO_BACKGROUND:.*#DISABLE_VIDEO_BACKGROUND: true,#" \
        -e "s#DISABLE_DOMINANT_SPEAKER_INDICATOR:.*#DISABLE_DOMINANT_SPEAKER_INDICATOR: true,#" \
        -e "s#DISABLE_JOIN_LEAVE_NOTIFICATIONS:.*#DISABLE_JOIN_LEAVE_NOTIFICATIONS: true,#" \
        /config/interface_config.js

    # Custom mobile apps
    sed -i \
        -e "s#// MOBILE_DOWNLOAD_LINK_ANDROID:.*#MOBILE_DOWNLOAD_LINK_ANDROID: '$MOBILE_DOWNLOAD_LINK_IOS',#" \
        -e "s#// MOBILE_DOWNLOAD_LINK_IOS:.*#MOBILE_DOWNLOAD_LINK_IOS: '$MOBILE_DOWNLOAD_LINK_IOS',#" \
        /config/interface_config.js

    # Disabling toolbar icons
    sed -i \
        -e "s#'info', ##" \
        -e "s#'sharedvideo', ##" \
        -e "s#'invite', ##" \
        -e "s#'videobackgroundblur', ##" \
        -e "s#'download', ##" \
        -e "s#'help', ##" \
        -e "s#'download', ##" \
        /config/interface_config.js

    # It will remove parameter 'closedcaptions' from TOOLBAR_BUTTONS if ENABLE_TRANSCRIPTIONS is false,
    # because it enabled by default, but not supported out of the box.
    if [[ $ENABLE_TRANSCRIPTIONS -ne 1 && "$ENABLE_TRANSCRIPTIONS" != "true" ]]; then
        sed -i \
            -e "s#'closedcaptions', ##" \
            /config/interface_config.js
    fi

fi

# Custom by Rustam
if [[ ! -f /usr/share/jitsi-meet/title.html ]]; then
    cp /defaults/custom/title.html /usr/share/jitsi-meet/title.html
    sed -i \
        -e "s#AppName#$MISSED_APP_NAME#g" \
        /usr/share/jitsi-meet/title.html
fi
# Copy all custom images
if [[ ! -f /usr/share/jitsi-meet/favicon.ico ]]; then
    cp /defaults/custom/images/favicon.ico /usr/share/jitsi-meet/favicon.ico
fi

if [[ ! -f /usr/share/jitsi-meet/images/favicon.ico ]]; then
    cp /defaults/custom/images/favicon.ico /usr/share/jitsi-meet/images/favicon.ico
fi

if [[ ! -f /usr/share/jitsi-meet/images/logo.png ]]; then
    cp /defaults/custom/images/logo.png /usr/share/jitsi-meet/images/logo.png
fi

if [[ ! -f /usr/share/jitsi-meet/images/logo_square.png ]]; then
    cp /defaults/custom/images/logo_square.png /usr/share/jitsi-meet/images/logo_square.png
fi

if [[ ! -f /usr/share/jitsi-meet/images/logo-deep-linking.png ]]; then
    cp /defaults/custom/images/logo-deep-linking.png /usr/share/jitsi-meet/images/logo-deep-linking.png
fi

#if [[ ! -f /usr/share/jitsi-meet/images/watermark.png ]]; then
#    cp /defaults/custom/images/watermark.png /usr/share/jitsi-meet/images/watermark.png
#fi

